### Index

- [Index](#index)
- [Overview](#overview)
- [Retrieve the Most Recent Orders with Customer Information](#retrieve-the-most-recent-orders-with-customer-information)
  - [Initial Query](#initial-query)
  - [Optimization Techniques](#optimization-techniques)
  - [Optimized Query](#optimized-query)
- [Identify Top Customers by Total Spending](#identify-top-customers-by-total-spending)
  - [Initial Query](#initial-query-1)
  - [Optimization Techniques](#optimization-techniques-1)
  - [Optimized Query](#optimized-query-1)
- [Retrieve the 1000 Most Recent Orders with Customer Details](#retrieve-the-1000-most-recent-orders-with-customer-details)
  - [Initial Query](#initial-query-2)
  - [Optimization Techniques](#optimization-techniques-2)
  - [Optimized Query](#optimized-query-2)
- [List Products with Low Stock](#list-products-with-low-stock)
  - [Initial Query](#initial-query-3)
  - [Optimization Techniques](#optimization-techniques-3)
  - [Optimized Query](#optimized-query-3)
- [Calculate Revenue Generated by Product Categories](#calculate-revenue-generated-by-product-categories)
  - [Initial Query](#initial-query-4)
  - [Optimization Techniques](#optimization-techniques-4)
  - [Optimized Query](#optimized-query-4)
- [Generate Daily Revenue Report](#generate-daily-revenue-report)
  - [Initial Query](#initial-query-5)
  - [Optimization Techniques](#optimization-techniques-5)
  - [Optimized Query](#optimized-query-5)

---

### Overview

All queries in this document operate on the following dataset:

- 10,000 Customers
- 1,000 Categories
- 15,000 Products
- 5,000,000 Orders
- 10,000,000 Order details

A script for inserting dummy data into each table is available [here](./dummy.md).

---

### Retrieve the Most Recent Orders with Customer Information

#### Initial Query

```sql
SELECT
    c.category_name,
    COUNT(p.product_category_id) AS total_products
FROM category c
LEFT JOIN product p
    ON c.category_id = p.product_category_id
GROUP BY c.category_id
ORDER BY total_products DESC;
```

**Execution Time:** 9.019 ms

#### Optimization Techniques

- Created an index on `product_category_id` in the `product` table to replace sequence scans with an index-only scan.
- Aggregated product counts in a subquery to minimize the number of rows processed during the `JOIN` operation.

#### Optimized Query

```sql
-- Create an index on product_category_id
CREATE INDEX idx_product_category_id ON product (product_category_id);

SELECT
    c.category_name,
    p.total_products
FROM category c
LEFT JOIN (
    -- Pre-aggregate product table to reduce join complexity
    SELECT
        p1.product_category_id,
        COUNT(p1.product_category_id) AS total_products
    FROM product p1
    GROUP BY p1.product_category_id
) AS p
ON c.category_id = p.product_category_id
ORDER BY total_products DESC;
```

**Execution Time After Optimization:** 2.744 ms

---

### Identify Top Customers by Total Spending

#### Initial Query

```sql
SELECT
    c.category_name, COUNT(p.product_id) AS total_products
FROM category c
LEFT JOIN product p
    ON c.category_id = p.product_category_id
GROUP BY c.category_id
ORDER BY total_products DESC;
```

**Execution Time:** 5.513 ms

#### Optimization Techniques

- Created an index on `order_customer_id` in the `orders` table to speed up joins.
- Pre-aggregated total spending and sorted results before limiting to the top 10 customers.
- Used a Common Table Expression (CTE) for better readability.
- Created a covering index on `customer` to optimize name retrieval.

#### Optimized Query

```sql
-- Create index on foreign key in orders
CREATE INDEX idx_order_customer_id ON orders(order_customer_id);

-- Create covering index on customer table
CREATE INDEX idx_customer_id_with_name ON customer(customer_id, customer_firstname, customer_lastname);

-- Use CTE to precompute total spending
WITH TopSpenders AS (
SELECT
    o2.order_customer_id,
    SUM(o2.order_total_amount) AS total_spending
FROM orders o2
GROUP BY o2.order_customer_id
ORDER BY total_spending DESC
LIMIT 10)

-- Retrieve top spenders with names
SELECT
    (c.customer_firstname || ' ' || c.customer_lastname) AS fullname, t.total_spending
FROM customer c
INNER JOIN TopSpenders t ON t.order_customer_id = c.customer_id;
```

**Execution Time After Optimization:** 867.979 ms

---

### Retrieve the 1000 Most Recent Orders with Customer Details

#### Initial Query

```sql
SELECT
    c.customer_firstname || ' ' || c.customer_lastname AS fullname,
    o.order_id,
    o.order_date
FROM customer c
INNER JOIN orders o
    ON o.order_customer_id = c.customer_id
ORDER BY o.order_date DESC
LIMIT 1000;
```

**Execution Time:** 953.956 ms

#### Optimization Techniques

- Created a covering index on `customer_id` including first and last name.
- Created an index on `order_date` to optimize sorting.
- Indexed `order_customer_id` to speed up the join.

#### Optimized Query

```sql
CREATE INDEX idx_customer_id_with_name ON customer(customer_id, customer_firstname, customer_lastname);
CREATE INDEX idx_orders_order_date ON orders (order_date);
CREATE INDEX idx_orders_customer ON orders(order_customer_id);
```

**Execution Time After Optimization:** 3.620 ms

---

### List Products with Low Stock

#### Initial Query

```sql
SELECT
    p.product_name,
    p.product_stock_quantity
FROM product p
WHERE p.product_stock_quantity < 10;
```

**Execution Time:** 18.324 ms

#### Optimization Techniques

- Created an index on `product_stock_quantity` to optimize filtering.

#### Optimized Query

```sql
CREATE INDEX idx_product_stock_quantity ON product(product_stock_quantity);
```

**Execution Time After Optimization:** 0.987 ms

---

### Calculate Revenue Generated by Product Categories

#### Initial Query

```sql
SELECT
    c.category_name,
    SUM(so.sales_quantity * so.sales_unit_price) AS total_revenue
FROM category c
LEFT JOIN product p ON c.category_id = p.product_category_id
LEFT JOIN sales_order so ON so.sales_product_id = p.product_id
INNER JOIN orders o ON so.sales_order_id = o.order_id
GROUP BY c.category_id;
```

**Execution Time:** 5210.034 ms

#### Optimization Techniques

- Pre-aggregated revenue data in a CTE to reduce join complexity.
- Used a Materialized View (MV) for faster reporting.

#### Optimized Query

```sql
-- Create materialized view for category revenue
CREATE MATERIALIZED VIEW category_revenue_mv AS (
SELECT
    p.product_category_id AS category_id,
    SUM(so.sales_quantity * so.sales_unit_price) AS total_revenue
FROM sales_order so
INNER JOIN product p ON so.sales_product_id = p.product_id
GROUP BY p.product_category_id);

-- Query the materialized view
SELECT
    c.category_name,
    cmv.total_revenue
FROM category c
INNER JOIN category_revenue_mv cmv ON c.category_id = cmv.category_id;
```

**Execution Time After Optimization:** 0.379 ms

---

### Generate Daily Revenue Report

#### Initial Query

```sql
SELECT
    COUNT(*) AS orders_count,
    SUM(o.order_total_amount) AS revenue
FROM orders o
WHERE o.order_date BETWEEN '2024-01-01 00:00:00' AND '2024-01-01 23:59:59';
```

**Execution Time:** 5.240 ms

#### Optimization Techniques

- Created a covering index on `order_date` including `order_total_amount`.

#### Optimized Query

```sql
CREATE INDEX idx_order_date_with_total_amount ON orders (order_date, order_total_amount);
```

**Execution Time After Optimization:** 1.416 ms
